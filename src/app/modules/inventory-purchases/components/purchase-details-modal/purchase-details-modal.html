<!-- Modal Backdrop -->
<div *ngIf="isOpen" class="fixed inset-0 bg-transparent z-[9997] flex justify-end" (click)="onClose()"
     (keydown.escape)="onClose()">

     <!-- Modal Panel - Aparece desde la derecha -->
     <div class="bg-white h-full w-full max-w-4xl shadow-2xl transform transition-transform duration-300 ease-out overflow-hidden flex flex-col"
          (click)="$event.stopPropagation()">

          <!-- Header -->
          <div class="px-6 py-4 bg-slate-800 border-b-4 border-indigo-600 flex-shrink-0">
               <div class="flex items-center justify-between">
                    <div class="flex items-center">
                         <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center mr-4">
                              <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor"
                                   viewBox="0 0 24 24">
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                   </path>
                              </svg>
                         </div>
                         <div>
                              <h2 class="text-xl font-bold text-white">Detalles de Compra</h2>
                              <p class="text-sm text-slate-300">{{ purchase.purchaseCode }} - {{ purchase.supplierName
                                   }}</p>
                         </div>
                    </div>
                    <div class="flex items-center space-x-3">
                         <!-- Estado Badge -->
                         <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
                              [class]="getStatusColor(purchase.status)">
                              <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20">
                                   <circle cx="10" cy="10" r="6"></circle>
                              </svg>
                              {{ PurchaseStatusConfig[purchase.status].label || purchase.status }}
                         </span>
                         <!-- Botón Cerrar -->
                         <button (click)="onClose()"
                              class="text-slate-300 hover:text-white p-2 rounded-lg hover:bg-slate-700 transition-colors">
                              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                              </svg>
                         </button>
                    </div>
               </div>
          </div>

          <!-- Scrollable Content -->
          <div class="flex-1 overflow-y-auto bg-slate-50">
               <!-- Resumen Principal -->
               <div class="bg-white border-b border-slate-200 p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                         <!-- Total Amount -->
                         <div class="text-center p-4 bg-indigo-50 rounded-lg">
                              <div class="text-2xl font-bold text-indigo-800">{{ formatCurrency(purchase.totalAmount) }}
                              </div>
                              <div class="text-sm text-indigo-600 font-medium">Monto Total</div>
                         </div>
                         <!-- Items Count -->
                         <div class="text-center p-4 bg-blue-50 rounded-lg">
                              <div class="text-2xl font-bold text-blue-800">{{ purchase.details.length || 0 }}</div>
                              <div class="text-sm text-blue-600 font-medium">Productos</div>
                         </div>
                         <!-- Progress -->
                         <div class="text-center p-4 bg-green-50 rounded-lg">
                              <div class="text-2xl font-bold text-green-800">{{ getCompletionPercentage() }}%</div>
                              <div class="text-sm text-green-600 font-medium">Completado</div>
                         </div>
                    </div>
               </div>

               <!-- Información General -->
               <div class="p-6 space-y-6">
                    <div class="bg-white rounded-lg shadow-sm border border-slate-200">
                         <div class="px-6 py-4 border-b border-slate-200 bg-slate-50">
                              <h3 class="text-lg font-semibold text-slate-800 flex items-center">
                                   <svg class="w-5 h-5 mr-2 text-slate-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                             d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                   </svg>
                                   Información General
                              </h3>
                         </div>
                         <div class="p-6">
                              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                   <!-- Columna Izquierda -->
                                   <div class="space-y-4">
                                        <div>
                                             <label class="block text-sm font-medium text-slate-600 mb-1">Código de
                                                  Compra</label>
                                             <div class="text-lg font-semibold text-slate-900">{{ purchase.purchaseCode
                                                  }}</div>
                                        </div>
                                        <div>
                                             <label
                                                  class="block text-sm font-medium text-slate-600 mb-1">Proveedor</label>
                                             <div class="text-lg text-slate-900">{{ purchase.supplierName }}</div>
                                             <div class="text-sm text-slate-500">{{ purchase.supplierCode }}</div>
                                        </div>
                                        <div>
                                             <label class="block text-sm font-medium text-slate-600 mb-1">Fecha de
                                                  Compra</label>
                                             <div class="text-lg text-slate-900">{{ formatDate(purchase.purchaseDate) }}
                                             </div>
                                        </div>
                                        <div>
                                             <label class="block text-sm font-medium text-slate-600 mb-1">Fecha de
                                                  Entrega</label>
                                             <div class="text-lg text-slate-900">{{ formatDate(purchase.deliveryDate) }}
                                             </div>
                                        </div>
                                   </div>

                                   <!-- Columna Derecha -->
                                   <div class="space-y-4">
                                        <div>
                                             <label class="block text-sm font-medium text-slate-600 mb-1">Estado</label>
                                             <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
                                                  [class]="getStatusColor(purchase.status)">
                                                  {{ PurchaseStatusConfig[purchase.status].label || purchase.status }}
                                             </span>
                                        </div>
                                        <div *ngIf="purchase.invoiceNumber">
                                             <label class="block text-sm font-medium text-slate-600 mb-1">Número de
                                                  Factura</label>
                                             <div class="text-lg text-slate-900">{{ purchase.invoiceNumber }}</div>
                                        </div>
                                        <div>
                                             <label class="block text-sm font-medium text-slate-600 mb-1">Solicitado
                                                  por</label>
                                             <div class="text-lg text-slate-900">{{ purchase.requestedByUser?.fullName
                                                  || 'N/A'
                                                  }}</div>
                                             <div class="text-sm text-slate-500">{{ purchase.requestedByUser?.userCode
                                                  || 'N/A'
                                                  }}</div>
                                        </div>
                                        <div>
                                             <label class="block text-sm font-medium text-slate-600 mb-1">Fecha de
                                                  Creación</label>
                                             <div class="text-lg text-slate-900">{{ formatDateTime(purchase.createdAt)
                                                  }}</div>
                                        </div>
                                   </div>
                              </div>

                              <!-- Observaciones -->
                              <div *ngIf="purchase.observations" class="mt-6 pt-6 border-t border-slate-200">
                                   <label class="block text-sm font-medium text-slate-600 mb-2">Observaciones</label>
                                   <div class="bg-slate-50 rounded-lg p-4 text-slate-900">
                                        {{ purchase.observations }}
                                   </div>
                              </div>
                         </div>
                    </div>

                    <!-- Información de la Organización -->
                    <div class="bg-white rounded-lg shadow-sm border border-slate-200">
                         <div class="px-6 py-4 border-b border-slate-200 bg-slate-50">
                              <h3 class="text-lg font-semibold text-slate-800 flex items-center">
                                   <svg class="w-5 h-5 mr-2 text-slate-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                             d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H9m0 0H7m2 0v-6a2 2 0 012-2h2a2 2 0 012 2v6">
                                        </path>
                                   </svg>
                                   Organización
                              </h3>
                         </div>
                         <div class="p-6">
                              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                   <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1">Nombre</label>
                                        <div class="text-lg text-slate-900">{{
                                             purchase.organizationInfo?.organizationName || 'N/A' }}</div>
                                   </div>
                                   <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1">Código</label>
                                        <div class="text-lg text-slate-900">{{
                                             purchase.organizationInfo?.organizationCode || 'N/A' }}</div>
                                   </div>
                                   <div *ngIf="purchase.organizationInfo?.address">
                                        <label class="block text-sm font-medium text-slate-600 mb-1">Dirección</label>
                                        <div class="text-lg text-slate-900">{{ purchase.organizationInfo?.address }}
                                        </div>
                                   </div>
                                   <div *ngIf="purchase.organizationInfo?.phone">
                                        <label class="block text-sm font-medium text-slate-600 mb-1">Teléfono</label>
                                        <div class="text-lg text-slate-900">{{ purchase.organizationInfo?.phone }}</div>
                                   </div>
                              </div>
                         </div>
                    </div>

                    <!-- Detalles de Productos -->
                    <div class="bg-white rounded-lg shadow-sm border border-slate-200">
                         <div class="px-6 py-4 border-b border-slate-200 bg-slate-50">
                              <div class="flex justify-between items-center">
                                   <h3 class="text-lg font-semibold text-slate-800 flex items-center">
                                        <svg class="w-5 h-5 mr-2 text-slate-600" fill="none" stroke="currentColor"
                                             viewBox="0 0 24 24">
                                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4">
                                             </path>
                                        </svg>
                                        Productos Solicitados
                                   </h3>
                                   <!-- Barra de Progreso -->
                                   <div class="flex items-center space-x-2">
                                        <span class="text-sm text-slate-600">{{ calculateTotalQuantityReceived() }}/{{
                                             calculateTotalQuantityOrdered() }}</span>
                                        <div class="w-24 h-2 bg-slate-200 rounded-full">
                                             <div class="h-2 rounded-full transition-all duration-300"
                                                  [class]="getProgressBarColor()"
                                                  [style.width.%]="getCompletionPercentage()"></div>
                                        </div>
                                   </div>
                              </div>
                         </div>
                         <div class="overflow-x-auto">
                              <table class="w-full">
                                   <thead class="bg-slate-50">
                                        <tr>
                                             <th
                                                  class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                                  Producto</th>
                                             <th
                                                  class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">
                                                  Cant. Ordenada</th>
                                             <th
                                                  class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">
                                                  Cant. Recibida</th>
                                             <th
                                                  class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">
                                                  Precio Unit.</th>
                                             <th
                                                  class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">
                                                  Subtotal</th>
                                             <th
                                                  class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">
                                                  Estado</th>
                                        </tr>
                                   </thead>
                                   <tbody class="bg-white divide-y divide-slate-200">
                                        <tr *ngFor="let detail of purchase.details; let i = index"
                                             class="hover:bg-slate-50">
                                             <!-- Producto -->
                                             <td class="px-6 py-4">
                                                  <div>
                                                       <div class="text-sm font-medium text-slate-900">{{
                                                            detail.productName }}</div>
                                                       <div class="text-sm text-slate-500">{{ detail.productCode }}
                                                       </div>
                                                       <div *ngIf="detail.observations"
                                                            class="text-xs text-slate-400 mt-1">
                                                            <em>{{ detail.observations }}</em>
                                                       </div>
                                                  </div>
                                             </td>
                                             <!-- Cantidad Ordenada -->
                                             <td class="px-6 py-4 text-center">
                                                  <span class="text-sm font-medium text-slate-900">{{
                                                       detail.quantityOrdered }}</span>
                                             </td>
                                             <!-- Cantidad Recibida -->
                                             <td class="px-6 py-4 text-center">
                                                  <span class="text-sm font-medium"
                                                       [class]="detail.quantityReceived >= detail.quantityOrdered ? 'text-green-600' :
                                                               detail.quantityReceived > 0 ? 'text-yellow-600' : 'text-slate-400'">
                                                       {{ detail.quantityReceived || 0 }}
                                                  </span>
                                             </td>
                                             <!-- Precio Unitario -->
                                             <td class="px-6 py-4 text-right">
                                                  <span class="text-sm font-medium text-slate-900">{{
                                                       formatCurrency(detail.unitCost) }}</span>
                                             </td>
                                             <!-- Subtotal -->
                                             <td class="px-6 py-4 text-right">
                                                  <span class="text-sm font-bold text-slate-900">{{
                                                       formatCurrency(detail.subtotal) }}</span>
                                             </td>
                                             <!-- Estado del Item -->
                                             <td class="px-6 py-4 text-center">
                                                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                                       [class]="detail.quantityReceived >= detail.quantityOrdered ? 'bg-green-100 text-green-800' :
                                                               detail.quantityReceived > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-slate-100 text-slate-800'">
                                                       {{ detail.quantityReceived >= detail.quantityOrdered ? 'Completo'
                                                       :
                                                       detail.quantityReceived > 0 ? 'Parcial' : 'Pendiente' }}
                                                  </span>
                                             </td>
                                        </tr>
                                   </tbody>
                              </table>
                         </div>
                    </div>
               </div>
          </div>

          <!-- Footer -->
          <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex justify-between items-center flex-shrink-0">
               <div class="text-sm text-slate-600">
                    Compra creada el {{ formatDateTime(purchase.createdAt) }}
               </div>
               <div class="flex space-x-3">
                    <button (click)="onClose()"
                         class="px-6 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-100 font-medium transition-colors">
                         Cerrar
                    </button>
               </div>
          </div>
     </div>
</div>