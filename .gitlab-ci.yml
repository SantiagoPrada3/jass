# =============================================================================
# GitLab CI/CD Pipeline - FRONTEND ANGULAR
# Construye y sube imagen Docker a DockerHub
# =============================================================================

stages:
  - build
  - test-selenium
  - docker-build

variables:
  DOCKER_IMAGE_NAME: 'santiagoprada1029/jass-vg-frontend'
  DOCKER_TAG: 'latest'
  NODE_VERSION: '22'

# Cache para optimizar builds
cache:
  key: '$CI_COMMIT_REF_SLUG'
  paths:
    - node_modules/
    - .npm/
    - dist/vg-web-sistemajass/browser/

# =============================================================================
# STAGE 1: Build Angular App
# =============================================================================
angular-build:
  stage: build
  image: node:22-alpine
  before_script:
    - echo "üöÄ Iniciando build del Frontend Angular..."
    - node --version
    - npm --version
    - echo "üì¶ Configurando cache de npm..."
    - npm config set cache .npm
  script:
    - echo "üì• Instalando dependencias..."
    - npm ci --silent
    - echo "üî® Compilando aplicaci√≥n Angular con base href..."
    - npm run build -- --configuration=production --base-href="/jass/SistemaJass/"
    - echo "üìã Verificando archivos generados..."
    - ls -la dist/vg-web-sistemajass/browser/
    - du -sh dist/vg-web-sistemajass/browser/
  artifacts:
    paths:
      - dist/vg-web-sistemajass/browser/
      - node_modules/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests
    - feature/ms-users


# =============================================================================
# STAGE 2: Test Selenium - Pruebas E2E
# =============================================================================
test-selenium:
  stage: test-selenium
  image: node:22
  services:
    - name: selenium/standalone-chrome:latest
      alias: selenium
  variables:
    # Variables para Selenium
    SELENIUM_REMOTE_URL: 'http://selenium:4444/wd/hub'
    CI: 'true'
    GITLAB_CI: 'true'
    # Habilitar modo de red compartida
    FF_NETWORK_PER_BUILD: 'true'
  before_script:
    - echo "üß™ Preparando pruebas E2E con Selenium..."
    - node --version
    - npm --version
    - echo "üì¶ Instalando dependencias..."
    - npm ci --silent
    - echo "üîç Obteniendo IP del contenedor..."
    - apt-get update && apt-get install -y curl net-tools > /dev/null 2>&1 || true
    - HOST_IP=$(hostname -I | awk '{print $1}')
    - echo "IP del host - $HOST_IP"
    - export BASE_URL="http://$HOST_IP:4200"
    - echo "Base URL configurada - $BASE_URL"
  script:
    - echo "üöÄ Iniciando servidor Angular en segundo plano..."
    - npm run start -- --host 0.0.0.0 &
    - echo "‚è≥ Esperando que el servidor est√© listo (60s)..."
    - sleep 60
    - echo "üîó Verificando conectividad..."
    - curl -s --max-time 10 http://localhost:4200 > /dev/null && echo "‚úÖ Servidor Angular respondiendo en localhost" || echo "‚ö†Ô∏è Servidor no responde a√∫n en localhost"
    - echo "üß™ Ejecutando pruebas E2E de Tipos de Incidencias..."
    - npm run e2e:incident-types 2>&1 | tee e2e-output.log || echo "‚ö†Ô∏è Pruebas E2E completadas"
    - echo "üìã Log de pruebas guardado en e2e-output.log"
  artifacts:
    when: always
    paths:
      - e2e/reports/
      - e2e-output.log
    expire_in: 1 week
  allow_failure: true
  dependencies:
    - angular-build
  only:
    - main
    - develop
    - feature/ms-users


# =============================================================================
# STAGE 3: Docker Build & Push
# =============================================================================
docker-build-push:
  stage: docker-build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: '/certs'
  before_script:
    - echo "üê≥ Configurando Docker..."
    - docker info
    - echo "üîë Autenticando con DockerHub..."
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - echo "üèóÔ∏è Construyendo imagen Docker del Frontend..."
    - docker build -t $DOCKER_IMAGE_NAME:$DOCKER_TAG .
    - docker build -t $DOCKER_IMAGE_NAME:$CI_COMMIT_SHORT_SHA .
    - echo "üì§ Subiendo imagen a DockerHub..."
    - docker push $DOCKER_IMAGE_NAME:$DOCKER_TAG
    - docker push $DOCKER_IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - echo "‚úÖ Imagen Frontend subida exitosamente:"
    - echo "   - $DOCKER_IMAGE_NAME:$DOCKER_TAG"
    - echo "   - $DOCKER_IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
    - echo "üìè Tama√±o de la imagen:"
    - docker images $DOCKER_IMAGE_NAME:$DOCKER_TAG
  after_script:
    - docker logout
  dependencies:
    - angular-build
  only:
    - main
    - develop
    - feature/ms-users


# =============================================================================
# ‚úÖ Pipeline completo hasta subir imagen a DockerHub
# =============================================================================
# =============================================================================
# Variables de entorno requeridas en GitLab:
# DOCKERHUB_USERNAME: santiagoprada1029
# DOCKERHUB_TOKEN: [CONFIGURAR EN GITLAB SECRETS]
# =============================================================================
